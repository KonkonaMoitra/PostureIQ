{% extends "base.html" %}
{% block title %}Dashboard ‚Äî PostureIQ{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
{% endblock %}

{% block content %}
<div class="container-pro">

  <!-- ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="dashboard-header">
    <p class="hero-eyebrow" style="margin-bottom:0.5rem;">Dashboard</p>
    <h1>Welcome back, {{ session.username }}</h1>
    <p style="font-size:0.9rem; color:var(--text-muted);">
      Here's an overview of your interview posture performance.
    </p>
  </div>

  <hr class="divider" />

  <!-- ‚îÄ‚îÄ Stats Grid ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="stats-grid">

    <div class="card-pro">
      <div class="card-label">Total Sessions</div>
      <div class="card-value">{{ total_sessions }}</div>
      <div class="card-sub">posture analyses completed</div>
    </div>

    <div class="card-pro">
      <div class="card-label">Avg Posture Score</div>
      <div class="card-value">
        {% if avg_score %}
          {{ avg_score }}<span style="font-size:1rem; color:var(--text-muted)">/100</span>
        {% else %}
          ‚Äî
        {% endif %}
      </div>
      <div class="card-sub">across all sessions</div>
    </div>

    <div class="card-pro">
      <div class="card-label">Improvement</div>
      <div class="card-value"
           style="color:{% if improvement >= 0 %}var(--success){% else %}var(--danger){% endif %}">
        {% if total_sessions >= 2 %}
          {{ '+' if improvement >= 0 else '' }}{{ improvement }}%
        {% else %}
          ‚Äî
        {% endif %}
      </div>
      <div class="card-sub">since first session</div>
    </div>

    <div class="card-pro">
      <div class="card-label">Latest Status</div>
      <div style="margin-top:0.5rem;">
        {% if latest %}
          {% set sc = latest.posture_score %}
          {% if sc >= 85 %}
            <span class="status-badge excellent" style="font-size:1rem; padding:0.5rem 1rem;">Excellent</span>
          {% elif sc >= 65 %}
            <span class="status-badge good" style="font-size:1rem; padding:0.5rem 1rem;">Good</span>
          {% elif sc >= 45 %}
            <span class="status-badge needs-imp" style="font-size:1rem; padding:0.5rem 1rem;">Needs Improvement</span>
          {% else %}
            <span class="status-badge poor" style="font-size:1rem; padding:0.5rem 1rem;">Poor</span>
          {% endif %}
          <div class="card-sub mt-1">{{ latest.created_at[:16] }}</div>
        {% else %}
          <span style="color:var(--text-muted); font-size:0.9rem;">No data yet</span>
        {% endif %}
      </div>
    </div>

  </div>

  <!-- ‚îÄ‚îÄ Chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  {% if total_sessions > 0 %}
  <div class="row g-4 mt-1">
    <div class="col-lg-8">
      <div class="card-pro">
        <div class="d-flex justify-between items-center mb-3">
          <div>
            <div class="card-label">Posture Score Over Time</div>
            <div style="font-family:var(--font-display); font-weight:700; font-size:1rem;">
              Score Trend
            </div>
          </div>
          <a href="{{ url_for('posture') }}" class="btn-primary-pro" style="font-size:0.8rem; padding:0.5rem 1rem;">
            New Analysis
          </a>
        </div>
        <div class="chart-container">
          <canvas id="posture-chart"></canvas>
        </div>
      </div>
    </div>

    <!-- Latest result breakdown -->
    <div class="col-lg-4">
      <div class="card-pro h-100">
        <div class="card-label mb-3">Latest Session Breakdown</div>

        {% if latest %}
        <!-- Score ring -->
        <div class="d-flex justify-center mb-3">
          <div class="score-ring">
            <svg viewBox="0 0 120 120" width="110" height="110">
              <circle class="ring-bg"   cx="60" cy="60" r="50" stroke-width="8"/>
              <circle class="ring-fill" cx="60" cy="60" r="50" stroke-width="8"
                stroke="{% if latest.posture_score >= 85 %}#10b981{% elif latest.posture_score >= 65 %}#3b82f6{% elif latest.posture_score >= 45 %}#f59e0b{% else %}#ef4444{% endif %}"
                stroke-dasharray="314.16"
                stroke-dashoffset="{{ 314.16 - (latest.posture_score / 100) * 314.16 }}"/>
            </svg>
            <div class="ring-label">
              <span class="ring-number"
                style="color:{% if latest.posture_score >= 85 %}#10b981{% elif latest.posture_score >= 65 %}#3b82f6{% elif latest.posture_score >= 45 %}#f59e0b{% else %}#ef4444{% endif %}">
                {{ latest.posture_score }}
              </span>
              <span class="ring-text">Score</span>
            </div>
          </div>
        </div>

        <!-- Angles -->
        <div class="angle-grid">
          <div class="angle-item">
            <div class="angle-val">{{ "%.1f"|format(latest.shoulder_angle or 0) }}¬∞</div>
            <div class="angle-label">Shoulder</div>
          </div>
          <div class="angle-item">
            <div class="angle-val">{{ "%.1f"|format(latest.neck_angle or 0) }}¬∞</div>
            <div class="angle-label">Neck</div>
          </div>
          <div class="angle-item">
            <div class="angle-val">{{ "%.1f"|format(latest.head_tilt or 0) }}¬∞</div>
            <div class="angle-label">Head Tilt</div>
          </div>
          <div class="angle-item">
            <div class="angle-val">{{ "%.1f"|format(latest.spine_angle or 0) }}¬∞</div>
            <div class="angle-label">Spine</div>
          </div>
        </div>
        {% else %}
        <p style="font-size:0.85rem; color:var(--text-muted); text-align:center; margin-top:2rem;">
          No sessions yet. Run your first analysis!
        </p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Recent Sessions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="card-pro mt-4">
    <div class="d-flex justify-between items-center mb-3">
      <div class="card-label">Recent Sessions</div>
      <span style="font-size:0.75rem; color:var(--text-muted);">Last 5 records</span>
    </div>
    <table class="table-pro">
      <thead>
        <tr>
          <th>Date</th>
          <th>Score</th>
          <th>Status</th>
          <th>Shoulder¬∞</th>
          <th>Neck¬∞</th>
          <th>Spine¬∞</th>
          <th>Report</th>
        </tr>
      </thead>
      <tbody>
    {% for r in records %}
<tr>
  <td class="mono" style="font-size:0.8rem;">{{ r.created_at[:16] }}</td>

  <td>
    <span style="font-family:var(--font-display); font-weight:700;
      color:{% if r.posture_score >= 85 %}#10b981
            {% elif r.posture_score >= 65 %}#3b82f6
            {% elif r.posture_score >= 45 %}#f59e0b
            {% else %}#ef4444{% endif %}">
      {{ r.posture_score }}
    </span>
    <span style="color:var(--text-muted); font-size:0.75rem;">/100</span>
  </td>

  <td>
    {% if r.posture_score >= 85 %}
      <span class="status-badge excellent">Excellent</span>
    {% elif r.posture_score >= 65 %}
      <span class="status-badge good">Good</span>
    {% elif r.posture_score >= 45 %}
      <span class="status-badge needs-imp">Needs Improvement</span>
    {% else %}
      <span class="status-badge poor">Poor</span>
    {% endif %}
  </td>

  <!-- ‚Üì UPDATED: show Mock badge if no angle data, otherwise show angles -->
  {% if r.shoulder_angle is none %}
    <td colspan="3" style="color:var(--text-muted); font-size:0.78rem;">
      <span style="background:rgba(59,130,246,0.1); color:var(--accent-bright);
                   padding:0.2rem 0.6rem; border-radius:99px; font-size:0.72rem;
                   font-weight:600;">‚è± Mock Session</span>
    </td>
  {% else %}
    <td class="mono">{{ "%.1f"|format(r.shoulder_angle or 0) }}¬∞</td>
    <td class="mono">{{ "%.1f"|format(r.neck_angle or 0) }}¬∞</td>
    <td class="mono">{{ "%.1f"|format(r.spine_angle or 0) }}¬∞</td>
  {% endif %}

  <td>
    <a href="{{ url_for('download_report', record_id=r.id) }}"
       class="btn-ghost"
       style="font-size:0.75rem; padding:0.3rem 0.7rem;">
      ‚¨á Download
    </a>
  </td>
</tr>
{% endfor %}
      </tbody>
    </table>
  </div>

  {% else %}
  <!-- Empty state -->
  <div class="card-pro text-center mt-4" style="padding:3rem;">
    <div style="font-size:3rem; margin-bottom:1rem;">üì∏</div>
    <h3 style="font-size:1.2rem; margin-bottom:0.5rem;">No sessions yet</h3>
    <p style="font-size:0.9rem; color:var(--text-muted); margin-bottom:1.5rem;">
      Run your first posture analysis to start building your improvement history.
    </p>
    <a href="{{ url_for('posture') }}" class="btn-primary-pro" style="margin:auto;">
      Start Analysis
    </a>
  </div>
  {% endif %}

</div>
{% endblock %}

{% block scripts %}
<script>
  {% if chart_labels %}
  document.addEventListener('DOMContentLoaded', () => {
    initDashboardChart(
      {{ chart_labels | tojson }},
      {{ chart_scores | tojson }}
    );
  });
  {% endif %}
</script>
{% endblock %}
